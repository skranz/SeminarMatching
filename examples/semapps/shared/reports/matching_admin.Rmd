
```{r setup, include=FALSE}
knitr::opts_chunk$set(error = TRUE, echo=FALSE, cache=FALSE)
library(ggplot2)
library(SeminarMatching)
library(dplyr)
library(tidyr)
library(reshape2)
```

```{r init_param, include=FALSE}
setwd("D:/libraries/SeminarMatching/semapps/shared/reports")
semester = "SS17"
db.dir = paste0("../db")
round = 1

semdb = dbConnect(dbname=paste0(db.dir,"/semDB.sqlite"), drv = SQLite())
matchings = dbGet(semdb,"matchings",nlist(semester, round))
seminars = dbGet(semdb,"seminars",nlist(semester))
students = dbGet(semdb,"students",nlist(semester))

```

```{r init_data, include=FALSE}
df = matchings %>% filter(num_ranked>0)

df = mutate(df, found=ifelse(semid!=-1, "found seminar", "no seminar"))

cols = c("semid",setdiff(colnames(seminars),colnames(df)))
df = left_join(df, seminars[,cols,drop=FALSE], by="semid")

cols = c("userid",setdiff(colnames(students),colnames(df)))
df = left_join(df, students[,cols,drop=FALSE], by="userid")

num.studs = length(unique(df$userid))
num.sems = length(unique(df$semid))
num.match = sum(df$semid != -1)
num.empty = sum(df$semid == -1)
total.slots = sum(seminars$slots)

r1fi = df %>% 
  filter(semid>-1) %>%
  group_by(semid) %>%
  summarize(filled_round1=n())

seminars = left_join(seminars,r1fi, by="semid")

```

# Matching Results for `r semester` round `r round`

- Note: The report considers only students that have ranked at least 1 seminar.

- We have `r num.studs` students and `r num.sems` seminars.

- `r num.match` of `r total.slots` seminar slots have been filled (`r round(100*num.match / total.slots)`%) and `r num.empty` students (`r round(100*num.empty / num.studs)`%) did not get assigned a seminar.

- On average a student listed `r round(mean(df$num_ranked),1)` seminars in the preference list.

Filled and open seminar slots after matching round 1:
```{r}
seminars %>%
  group_by(semBAMA) %>%
  summarize(num_sems=n(), total_slots=sum(slots,na.rm=TRUE), filled=sum(filled_round1,na.rm=TRUE), open=total_slots-filled)

```


The following table shows for Bachelor and Master students, how many students found or found not a seminar.
```{r }
sdf = df %>%
  group_by(studBAMA,found) %>% 
  summarise(n=n()) %>%
  ungroup() %>%
  spread(key = found, value=n) %>%
  replace.na(0) %>%
  as.data.frame()

if (ncol(sdf)==2)
  sdf$not_found  = 0
  
sdf$total = sdf[,2]+sdf[,3]
sdf
```

Here are the shares of students that got the seminar that they ranked at n'th position... 
```{r }
df %>%
  filter(num_ranked >0) %>%
  group_by(studBAMA) %>%
  mutate(N=n()) %>%
  group_by(studBAMA,pos, found) %>% 
  summarise(share = paste0(round(100*n() / first(N),1),"%")) %>%
  ungroup() %>%
  filter(found == "found seminar") %>%
  dcast(pos ~ studBAMA+found, value.var="share") %>%
  mutate(pos = paste0("Ranked ",pos)) %>%
  replace.na("0%")
```

And now we show how the length of a students' preference lists relates with the share of students that got assigned a seminar:
```{r}
df %>% 
  group_by(studBAMA,num_ranked) %>% 
  mutate(N=n()) %>%
  group_by(studBAMA,num_ranked, found) %>% 
  summarise(share = paste0(round(100*n() / first(N),1),"%")) %>%
  dcast(num_ranked ~ studBAMA + found,value.var="share") %>%
  replace.na("0%")
```

Here are the number of students that rankend `num_ranked` seminars:
```{r}
df %>% 
  group_by(studBAMA,num_ranked) %>% 
  summarise(number_students=n()) %>%
  dcast(num_ranked ~ studBAMA,value.var="number_students") %>%
  replace.na(0) %>%
  mutate("Total Number of Students" = Bachelor + Master)
```


Let us now compare for Bachelor students the seminar matching by their main subject:

```{r}
df %>% 
  filter(studBAMA=="Bachelor") %>% 
  group_by(studSubject) %>%
  mutate(mean_num_sem_ranked=round(mean(num_ranked),1)) %>%
  group_by(studSubject, mean_num_sem_ranked, found) %>% 
  summarise(n=n()) %>%
  dcast(studSubject + mean_num_sem_ranked ~ found,value.var="n") %>%
  arrange(-`found seminar`) %>%
  replace.na(0)
```

and the same thing for master students...
```{r}
df %>% 
  filter(studBAMA=="Master") %>% 
  group_by(studSubject) %>%
  mutate(mean_num_sem_ranked=round(mean(num_ranked),1)) %>%
  group_by(studSubject, mean_num_sem_ranked, found) %>% 
  summarise(n=n()) %>%
  dcast(studSubject + mean_num_sem_ranked ~ found,value.var="n") %>%
  arrange(-`found seminar`) %>%
  replace.na(0)
```


# Filled slots after all matching rounds and manual assignments

```{r}
seminars %>%
  group_by(semBAMA) %>%
  summarize(num_sems=n(), total_slots=sum(slots), filled=sum(filled_slots), open=total_slots-filled)
```

